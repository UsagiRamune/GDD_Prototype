<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Perfect Puff: Fixed UI</title>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
        canvas { display: block; margin: 0 auto; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<script>

class MainScene extends Phaser.Scene {
    constructor() { super('MainScene'); }

    create() {
        // --- 1. Init Data ---
        this.gameState = 'MENU'; 
        this.playerCount = 1;
        this.gameMode = 'TIME'; // 'TIME' or 'RACE'
        
        // --- 2. Background ---
        this.add.rectangle(640, 360, 1280, 720, 0x222222);
        this.splitLine = this.add.line(0, 0, 640, 0, 640, 720, 0xffffff, 0.2).setOrigin(0).setVisible(false);

        // --- 3. UI Containers (แยกกลุ่มชัดเจน) ---
        this.menuContainer = this.add.container(0, 0); // กลุ่มเมนู
        this.gameContainer = this.add.container(0, 0).setVisible(false); // กลุ่มในเกม (ซ่อนไว้ก่อน)
        this.resultContainer = this.add.container(0, 0).setVisible(false); // กลุ่มจบเกม

        // --- 4. Setup Menu UI ---
        this.createMenuUI();

        // --- 5. Setup Game UI ---
        this.timerText = this.add.text(640, 50, 'READY', { fontSize: '48px', fontStyle: 'bold', color: '#fff' }).setOrigin(0.5);
        let backBtn = this.createButton(80, 50, 'BACK', 0x444444, 100, 40, () => this.resetToMenu());
        this.gameContainer.add([this.timerText, backBtn]);

        // --- 6. Setup Players ---
        this.p1 = new Player(this, 1, 0x33ccff);
        this.p2 = new Player(this, 2, 0xff33cc);

        // --- 7. Input Handling ---
        this.keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
        this.keyRight = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
        this.input.addPointer(2); // Multitouch
    }

    createMenuUI() {
        // Title
        let title = this.add.text(640, 150, 'PERFECT PUFF', { fontSize: '80px', fontStyle: 'bold', color: '#fff' }).setOrigin(0.5);
        
        // Toggles
        this.btn1P = this.createToggle(440, 300, '1 PLAYER', true, () => this.setPlayerMode(1));
        this.btn2P = this.createToggle(840, 300, '2 PLAYERS', false, () => this.setPlayerMode(2));
        this.btnTime = this.createToggle(440, 400, 'TIME ATTACK', true, () => this.setGameMode('TIME'));
        this.btnRace = this.createToggle(840, 400, 'RACE MODE', false, () => this.setGameMode('RACE'));

        // Start
        let startBtn = this.createButton(640, 550, 'START GAME', 0x00aa00, 300, 80, () => this.startGame());

        this.menuContainer.add([title, this.btn1P, this.btn2P, this.btnTime, this.btnRace, startBtn]);
    }

    createToggle(x, y, text, isActive, callback) {
        let color = isActive ? 0x00ff00 : 0x555555;
        let bg = this.add.rectangle(x, y, 300, 60, color).setInteractive();
        let txt = this.add.text(x, y, text, { fontSize: '24px', color: '#fff' }).setOrigin(0.5);
        bg.on('pointerdown', callback);
        bg.label = txt; // เก็บ ref ไว้ใช้ตอนเปลี่ยนสี
        return bg;
    }

    createButton(x, y, text, color, w, h, callback) {
        let bg = this.add.rectangle(x, y, w, h, color).setInteractive();
        let txt = this.add.text(x, y, text, { fontSize: '24px', fontStyle: 'bold' }).setOrigin(0.5);
        bg.on('pointerdown', callback);
        return bg;
    }

    setPlayerMode(count) {
        this.playerCount = count;
        this.btn1P.setFillStyle(count === 1 ? 0x0088ff : 0x555555);
        this.btn2P.setFillStyle(count === 2 ? 0x0088ff : 0x555555);
    }

    setGameMode(mode) {
        this.gameMode = mode;
        this.btnTime.setFillStyle(mode === 'TIME' ? 0xffaa00 : 0x555555);
        this.btnRace.setFillStyle(mode === 'RACE' ? 0xffaa00 : 0x555555);
    }

    startGame() {
        this.gameState = 'PLAYING';
        
        // สลับ UI: ซ่อนเมนู -> โชว์เกม
        this.menuContainer.setVisible(false);
        this.resultContainer.setVisible(false);
        this.gameContainer.setVisible(true);
        
        this.splitLine.setVisible(this.playerCount === 2);

        // Setup Positions
        if (this.playerCount === 1) {
            this.p1.activate(640, 360);
            this.p2.deactivate();
        } else {
            this.p1.activate(320, 360);
            this.p2.activate(960, 360);
        }

        // Logic เริ่มเกม
        if (this.gameMode === 'TIME') {
            this.timeLeft = 60;
            this.timerText.setText(this.timeLeft);
            this.timeEvent = this.time.addEvent({ delay: 1000, loop: true, callback: () => {
                if(this.gameState !== 'PLAYING') return;
                this.timeLeft--;
                this.timerText.setText(this.timeLeft);
                if(this.timeLeft <= 0) this.endGame();
            }});
        } else {
            this.targetScore = 5;
            this.timerText.setText(`FIRST TO ${this.targetScore}`);
        }
    }

    resetToMenu() {
        this.gameState = 'MENU';
        // สลับ UI: ซ่อนเกม -> โชว์เมนู
        this.gameContainer.setVisible(false);
        this.resultContainer.setVisible(false);
        this.menuContainer.setVisible(true);
        this.splitLine.setVisible(false);

        this.p1.deactivate();
        this.p2.deactivate();
        if(this.timeEvent) this.timeEvent.remove();
    }

    update(time, delta) {
        if (this.gameState !== 'PLAYING') return;

        // Reset Input
        let p1_pressed = false;
        let p2_pressed = false;

        // Check Input (Keyboard + Touch)
        if (this.keyA.isDown) p1_pressed = true;
        if (this.keyRight.isDown) p2_pressed = true;

        let pointers = [this.input.pointer1, this.input.pointer2, this.input.activePointer];
        pointers.forEach(p => {
            if (p.isDown) {
                if (this.playerCount === 1) p1_pressed = true;
                else {
                    if (p.x < 640) p1_pressed = true;
                    else p2_pressed = true;
                }
            }
        });

        this.p1.update(delta, p1_pressed);
        if (this.playerCount === 2) this.p2.update(delta, p2_pressed);

        // Win Condition Race Mode
        if (this.gameMode === 'RACE') {
            if (this.p1.score >= this.targetScore) this.endGame('P1 WINS!');
            if (this.playerCount === 2 && this.p2.score >= this.targetScore) this.endGame('P2 WINS!');
        }
    }

    endGame(msg) {
        this.gameState = 'GAMEOVER';
        // ซ่อนเกม UI บางส่วน (เช่น Timer) แต่โชว์ Result Overlay
        if (!msg) { 
             msg = (this.playerCount === 1) ? `SCORE: ${this.p1.score}` : 
                   (this.p1.score > this.p2.score) ? 'P1 WINS!' : 
                   (this.p2.score > this.p1.score) ? 'P2 WINS!' : 'DRAW!';
        }
        
        // สร้างหน้าจอจบเกมแบบง่ายๆ
        this.resultContainer.removeAll(true);
        let bg = this.add.rectangle(640, 360, 800, 400, 0x000000, 0.9);
        let txt = this.add.text(640, 300, msg, { fontSize: '60px', color: '#fff', fontStyle: 'bold' }).setOrigin(0.5);
        let backBtn = this.createButton(640, 450, 'MENU', 0xffffff, 200, 60, () => this.resetToMenu());
        
        this.resultContainer.add([bg, txt, backBtn]);
        this.resultContainer.setVisible(true);
    }
}

class Player {
    constructor(scene, id, color) {
        this.scene = scene;
        this.id = id;
        this.color = color;
        this.isActive = false;

        // Settings
        this.minSafeSize = 100;    // เล็กกว่านี้ = Too Small
        this.perfectSize = 130;    // เริ่ม Perfect Zone
        this.maxSize = 150;        // แตกที่นี่
        
        this.container = scene.add.container(0, 0).setVisible(false);
        
        // --- Visual Components ---
        // 1. วงแหวนเป้าหมาย (Static Target Ring)
        this.targetRing = scene.add.graphics();
        this.drawTargetRing(0x888888); // สีเทาตอนปกติ
        
        // 2. ตัวลูกโป่ง (Dynamic)
        this.circle = scene.add.circle(0, 0, 50, color);
        
        // 3. Text
        this.scoreText = scene.add.text(0, -220, '0', { fontSize: '50px', fontStyle: 'bold' }).setOrigin(0.5);
        
        this.container.add([this.targetRing, this.circle, this.scoreText]);
    }

    drawTargetRing(color) {
        this.targetRing.clear();
        // วาดวงแหวนเป้าหมาย: Safe Zone (Good)
        this.targetRing.lineStyle(4, color, 0.5); // เส้นขอบนอก
        this.targetRing.strokeCircle(0, 0, this.maxSize);
        
        // วาดวง Perfect (ข้างใน)
        this.targetRing.lineStyle(2, color, 0.3); 
        this.targetRing.strokeCircle(0, 0, this.perfectSize);
    }

    resetState() {
        this.score = 0;
        this.currentSize = 50;
        this.isStunned = false;
        this.scoreText.setText('0');
        this.circle.setRadius(50);
        this.circle.setFillStyle(this.color);
        this.drawTargetRing(0x888888);
    }

    activate(x, y) {
        this.isActive = true;
        this.container.setPosition(x, y).setVisible(true);
        this.resetState();
    }

    deactivate() {
        this.isActive = false;
        this.container.setVisible(false);
    }

    update(delta, isPressing) {
        if (!this.isActive || this.isStunned) return;

        if (isPressing) {
            // Growing
            this.currentSize += 0.25 * delta;
            this.circle.setRadius(this.currentSize);

            // Real-time Feedback (เปลี่ยนสีวงแหวนเมื่อถึงเกณฑ์)
            if (this.currentSize >= this.perfectSize && this.currentSize < this.maxSize) {
                this.drawTargetRing(0x00ff00); // สีเขียวเมื่อเข้า Perfect Zone
            } else if (this.currentSize >= this.minSafeSize) {
                this.drawTargetRing(0xffff00); // สีเหลืองเมื่อเข้า Good Zone
            }

            // Check Pop
            if (this.currentSize >= this.maxSize) {
                this.pop();
            }
        } else {
            // Released
            if (this.currentSize > 50) { // ต้องกดมานิดนึงก่อนถึงจะเช็ค
                this.evaluateScore();
            }
        }
    }

    evaluateScore() {
        let earned = 0;
        let msg = "";
        let color = "#fff";

        if (this.currentSize < this.minSafeSize) {
            // Case 1: Too Small
            msg = "TOO SMALL";
            color = "#aaaaaa";
            earned = 0; // ไม่ได้แต้ม
        } 
        else if (this.currentSize >= this.minSafeSize && this.currentSize < this.perfectSize) {
            // Case 2: Good (Safe Zone)
            msg = "GOOD";
            color = "#ffff00";
            earned = (this.scene.gameMode === 'TIME') ? 50 : 1; 
        } 
        else if (this.currentSize >= this.perfectSize && this.currentSize < this.maxSize) {
            // Case 3: Perfect
            msg = "PERFECT!";
            color = "#00ff00";
            earned = (this.scene.gameMode === 'TIME') ? 100 : 1; 
        }

        if (msg !== "TOO SMALL") {
             this.score += earned;
             this.scoreText.setText(this.score);
             this.resetBalloon();
        } else {
            // Too small: ไม่นับ ให้โอกาสแก้ตัว (ไม่ Reset หรือ Reset แล้วแต่ดีไซน์) 
            // ในที่นี้ให้ Reset เพื่อความแฟร์
             this.resetBalloon();
        }
        
        this.showFloatText(msg, color);
    }

    resetBalloon() {
        this.currentSize = 50;
        this.circle.setRadius(50);
        this.drawTargetRing(0x888888); // กลับเป็นสีเทา
    }

    pop() {
        this.showFloatText('POP!', '#ff0000');
        this.scene.cameras.main.shake(100, 0.005);
        this.isStunned = true;
        this.circle.setFillStyle(0x555555);
        
        let stunTime = (this.scene.gameMode === 'TIME') ? 2000 : 500;
        this.scene.time.delayedCall(stunTime, () => {
            this.isStunned = false;
            this.resetBalloon();
            this.circle.setFillStyle(this.color);
        });
    }

    showFloatText(msg, color) {
        let t = this.scene.add.text(this.container.x, this.container.y, msg, { 
            fontSize: '40px', color: color, fontStyle: 'bold', stroke: '#000', strokeThickness: 4
        }).setOrigin(0.5);
        
        this.scene.tweens.add({
            targets: t,
            y: t.y - 100,
            alpha: 0,
            duration: 800,
            onComplete: () => t.destroy()
        });
    }
}

const config = {
    type: Phaser.AUTO,
    width: 1280,
    height: 720,
    backgroundColor: '#1a1a1a',
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
    scene: MainScene
};

const game = new Phaser.Game(config);

</script>
</body>
</html>